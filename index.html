<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Tiny RAG Visualizer â€” Client-side Embeddings (Drive-backed)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0b0d10; --panel:#12161b; --muted:#8a96a3; --fg:#e8eef5; --acc:#69b6ff; --ok:#5bd68a; --warn:#ffb15a; --err:#ff6b6b; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    h1{font-size:18px;margin:16px 0}
    .app{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{background:var(--panel);border:1px solid #1d2430;border-radius:10px;padding:12px;flex:1}
    .col.sm{flex:0 0 380px}
    label{display:block;margin:10px 0 6px;color:var(--muted)}
    input[type="range"]{width:100%}
    input[type="number"],textarea,select,input[type="text"]{width:100%;background:#0f141b;border:1px solid #222b39;color:var(--fg);border-radius:8px;padding:8px}
    textarea{min-height:70px;resize:vertical}
    .btn{background:#1b2532;border:1px solid #2a374a;color:var(--fg);padding:8px 10px;border-radius:8px;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .muted{color:var(--muted)}
    .bar{height:8px;background:#233044;border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:100%;background:var(--acc)}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f1620;border:1px solid #263248;margin-right:6px}
    .chunk{background:#0e131a;border:1px solid #1a2230;border-radius:8px;padding:8px;margin:8px 0}
    .chunk .score{float:right;color:var(--muted)}
    code.inline{background:#0c1218;border:1px solid #1b2330;border-radius:6px;padding:2px 6px}
    .pipeline{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .pipebox{background:#0e141b;border:1px solid #1f2837;border-radius:10px;padding:8px 10px;min-width:140px}
    .pipebox.good{outline:2px solid var(--ok)}
    .pipebox.warn{outline:2px solid var(--warn)}
    .pipebox.err{outline:2px solid var(--err)}
    .arrow{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .small{font-size:12px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .footer{margin-top:8px;color:var(--muted)}
    progress{width:100%}
  </style>
  <!-- Transformers.js (WebGPU/WebGL/WASM) -->
  <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2"></script>
</head>
<body>
<div class="app">
  <h1>ðŸ§© Tiny RAG Visualizer â€” <span class="muted">client-side embeddings from Google Drive</span></h1>

  <div class="row">
    <div class="col sm">
      <label>Google Drive dataset.json (directDownload URL)</label>
      <input id="dsUrl" type="text" value="https://drive.google.com/uc?export=download&id=1u5YBq6qxQC1G4JgF4VXAUxCo-1r5YSul" />
      <label>Google Drive queries.json (directDownload URL)</label>
      <input id="qUrl" type="text" value="https://drive.google.com/uc?export=download&id=1gDUxkQN64yfvphcufeI_VAgIVp7bryUF" />

      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <button class="btn" id="init">Load & Embed</button>
        <span id="status" class="muted small">idle</span>
      </div>

      <div style="margin-top:6px">
        <progress id="prog" value="0" max="1" style="display:none"></progress>
      </div>

      <label style="margin-top:14px">Model</label>
      <select id="model" disabled>
        <option value="Xenova/all-MiniLM-L6-v2">Xenova/all-MiniLM-L6-v2 (quantized)</option>
      </select>

      <label>Query (from your Drive file)</label>
      <select id="querySel" disabled></select>

      <div class="grid">
        <div>
          <label>Top-k</label>
          <input id="topk" type="range" min="1" max="10" step="1" value="6"/>
          <input id="topkNum" type="number" min="1" max="10" step="1" value="6"/>
        </div>
        <div>
          <label>Normalize & cosine</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="normalize" type="checkbox" checked />
            <span class="muted small">unit-length vectors</span>
          </div>
        </div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <span class="badge">N docs: <span id="ndocs">â€”</span></span>
        <span class="badge">dim: <span id="dim">â€”</span></span>
      </div>

      <div class="footer small">
        Loads your JSONs from Google Drive (anyone-with-link), embeds with <code class="inline">Transformers.js</code> (MiniLM-L6-v2).
      </div>
    </div>

    <div class="col">
      <label>Pipeline</label>
      <div class="pipeline" id="pipeline">
        <div class="pipebox" id="p0">Fetch JSON<br><span class="muted small" id="p0meta">â€”</span></div>
        <div class="arrow">âžœ</div>
        <div class="pipebox" id="p1">Embed docs<br><span class="muted small" id="p1meta">â€”</span></div>
        <div class="arrow">âžœ</div>
        <div class="pipebox" id="p2">Embed query<br><span class="muted small" id="p2meta">â€”</span></div>
        <div class="arrow">âžœ</div>
        <div class="pipebox" id="p3">Retrieve<br><span class="muted small" id="p3meta">â€”</span></div>
        <div class="arrow">âžœ</div>
        <div class="pipebox" id="p4">Assemble<br><span class="muted small" id="p4meta">â€”</span></div>
      </div>

      <div class="grid" style="margin-top:10px">
        <div>
          <label>Retrieved docs <span class="muted small" id="retCount">0</span></label>
          <div id="results"></div>
        </div>
        <div>
          <label>Assembled Context</label>
          <div class="chunk mono small" id="context" style="white-space:pre-wrap; max-height:340px; overflow:auto"></div>
        </div>
      </div>

      <div style="margin-top:10px">
        <span class="badge">t_fetch: <span id="t0">â€”</span> ms</span>
        <span class="badge">t_embed_docs: <span id="t1">â€”</span> ms</span>
        <span class="badge">t_embed_query: <span id="t2">â€”</span> ms</span>
        <span class="badge">t_retrieve: <span id="t3">â€”</span> ms</span>
      </div>

      <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
        <button class="btn" id="run" disabled>Run</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------------- helpers / UI ---------------- */
const $ = s => document.querySelector(s);
const syncPair=(range,num)=>{range.addEventListener('input',()=>num.value=range.value);num.addEventListener('input',()=>range.value=num.value);};
syncPair($('#topk'), $('#topkNum'));

function setPipe(id, meta, cls='good'){
  const el = $(id);
  el.classList.remove('good','warn','err');
  el.classList.add(cls);
  $(id+'meta').textContent = meta;
}

/* ---------------- state ---------------- */
let DOCS = [];         // [{id,title,text}]
let QUERIES = [];      // [string]
let DOC_EMB = null;    // Float32Array length = N*D
let D = 0;             // embedding dim
let extractor = null;  // transformers.js pipeline

/* ---------------- fetch JSON from Drive ---------------- */
async function fetchJSON(url) {
  const res = await fetch(url, { method: 'GET' });
  if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
  // Some Drive files return text/plain â€” still JSON
  const txt = await res.text();
  try { return JSON.parse(txt); } catch(e) { throw new Error('Invalid JSON content'); }
}

function normalizeVec(v){
  let s=0; for(let i=0;i<v.length;i++) s+=v[i]*v[i];
  const n = Math.sqrt(s) || 1;
  for(let i=0;i<v.length;i++) v[i]=v[i]/n;
  return v;
}

function cosineTopK(q, topk){
  const N = DOCS.length, dim = D;
  const scores = new Array(N);
  const t0 = performance.now();
  for(let i=0;i<N;i++){
    let s=0;
    const base = i*dim;
    for(let j=0;j<dim;j++) s += q[j] * DOC_EMB[base+j];
    scores[i] = [i, s];
  }
  scores.sort((a,b)=>b[1]-a[1]);
  $('#t3').textContent = (performance.now()-t0).toFixed(1);
  return scores.slice(0, topk).map((p, idx)=>({rank: idx+1, idx: p[0], score: p[1]}));
}

/* ---------------- embeddings ---------------- */
async function loadModel(){
  const { pipeline } = window.transformers;
  extractor = await pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2', { quantized: true });
}

async function embedBatch(texts, normalize){
  const out = await extractor(texts, { pooling: 'mean', normalize });
  if (out?.data && out?.dims?.length === 2) {
    return { data: out.data, dim: out.dims[1] };
  } else if (Array.isArray(out)) {
    const dim = out[0].length;
    const data = new Float32Array(out.length * dim);
    for(let i=0;i<out.length;i++) data.set(out[i], i*dim);
    return { data, dim };
  } else {
    const vec = out?.data ? out.data : Float32Array.from(out);
    return { data: vec, dim: vec.length };
  }
}

async function embedAllDocs(){
  const B = 16;
  const N = DOCS.length;
  let dim = null;
  const store = [];
  const t0 = performance.now();
  const prog = $('#prog'); prog.style.display='block'; prog.value = 0; prog.max = Math.ceil(N / B);

  for(let i=0;i<N;i+=B){
    const chunk = DOCS.slice(i, i+B).map(d=>d.text);
    const { data, dim: d } = await embedBatch(chunk, $('#normalize').checked);
    if(dim==null) dim = d;
    store.push(data);
    prog.value += 1;
  }
  const all = new Float32Array(store.reduce((s,a)=>s+a.length,0));
  let off=0; for(const a of store){ all.set(a, off); off += a.length; }
  D = dim; DOC_EMB = all;

  $('#dim').textContent = String(D);
  $('#t1').textContent = (performance.now()-t0).toFixed(1);
  setPipe('#p1', `embedded ${N} docs`, 'good');
  prog.style.display='none';
}

async function embedOneQuery(qText){
  const out = await extractor(qText, { pooling: 'mean', normalize: $('#normalize').checked });
  let qv;
  if(out?.data) qv = out.data;
  else if(Array.isArray(out)) qv = Float32Array.from(out[0]);
  else qv = Float32Array.from(out);
  if(!$('#normalize').checked) normalizeVec(qv);
  return qv;
}

/* ---------------- UI ---------------- */
function fillQueries(){
  const sel = $('#querySel');
  sel.innerHTML = '';
  QUERIES.forEach((q,i)=>{
    const opt = document.createElement('option');
    opt.value = String(i);
    opt.textContent = q;
    sel.appendChild(opt);
  });
  sel.disabled = false;
}

function renderResults(items){
  const res = $('#results'); res.innerHTML='';
  $('#retCount').textContent = String(items.length);
  const assembled = [];
  items.forEach(it=>{
    const d = DOCS[it.idx];
    const wrap = document.createElement('div'); wrap.className='chunk';
    const bar = document.createElement('div'); bar.className='bar'; bar.title=String(it.score.toFixed(4));
    const fill = document.createElement('i'); fill.style.width = `${Math.max(0, Math.min(1, it.score))*100}%`;
    bar.appendChild(fill);
    const header = document.createElement('div');
    header.innerHTML = `<strong>#${it.rank}</strong> <span class="muted">doc</span> <code class="inline">${d.id}</code> <span class="score">score: ${it.score.toFixed(3)}</span><br><span class="muted small">${d.title || '(no title)'}</span>`;
    const text = document.createElement('div'); text.className='small'; text.style.marginTop='6px';
    const t = d.text; text.textContent = t.slice(0, 420) + (t.length>420 ? 'â€¦' : '');
    wrap.appendChild(header); wrap.appendChild(bar); wrap.appendChild(text);
    res.appendChild(wrap);
    assembled.push(d.text);
  });
  $('#context').textContent = assembled.join('\n\n');
}

/* ---------------- wiring ---------------- */
$('#init').addEventListener('click', async ()=>{
  try{
    const dsUrl = $('#dsUrl').value.trim();
    const qUrl  = $('#qUrl').value.trim();

    $('#status').textContent = 'fetching JSONâ€¦';
    setPipe('#p0','fetching dataset & queriesâ€¦','warn');
    const t0 = performance.now();
    const [ds, qs] = await Promise.all([fetchJSON(dsUrl), fetchJSON(qUrl)]);

    // dataset.json is a list of {id,title,text}
    if(!Array.isArray(ds)) throw new Error('dataset.json must be a JSON array');
    DOCS = ds.map((r,i)=>({ id: String(r.id ?? `row-${i}`), title: String(r.title ?? ''), text: String(r.text ?? '') }));
    $('#ndocs').textContent = String(DOCS.length);

    // queries.json can be list or {queries:[...]}
    QUERIES = Array.isArray(qs) ? qs.slice() : (Array.isArray(qs.queries) ? qs.queries.slice() : []);
    if(QUERIES.length === 0) throw new Error('queries.json is empty');

    $('#t0').textContent = (performance.now()-t0).toFixed(1);
    setPipe('#p0', `dataset: ${DOCS.length} â€¢ queries: ${QUERIES.length}`, 'good');

    $('#status').textContent = 'loading modelâ€¦';
    setPipe('#p1','loading modelâ€¦','warn');
    await loadModel();

    $('#status').textContent = 'embedding docsâ€¦';
    await embedAllDocs();

    fillQueries();
    $('#model').disabled = false;
    $('#run').disabled = false;
    $('#status').textContent = 'ready';
    setPipe('#p2','pick a query','warn');
  }catch(e){
    console.error(e);
    $('#status').textContent = 'failed: ' + e.message;
    setPipe('#p0','failed','err'); setPipe('#p1','failed','err');
  }
});

$('#run').addEventListener('click', async ()=>{
  try{
    const qi = +$('#querySel').value|0;
    const qText = QUERIES[qi];
    setPipe('#p2', `query #${qi+1}`, 'good');

    const t0 = performance.now();
    const qv = await embedOneQuery(qText);
    $('#t2').textContent = (performance.now()-t0).toFixed(1);

    const k = +$('#topk').value|0;
    const items = cosineTopK(qv, k);
    renderResults(items);
    setPipe('#p3', `top-k=${k}`, 'good');
    setPipe('#p4', 'assembled', 'good');
  }catch(e){
    console.error(e);
    setPipe('#p3', 'failed', 'err');
  }
});

window.addEventListener('load', ()=>{
  setPipe('#p0','idle','warn');
  $('#status').textContent = 'idle';
});
</script>
</body>
</html>
