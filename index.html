<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Tiny RAG Visualizer â€” Precomputed Docs (HF)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0b0d10; --panel:#12161b; --muted:#8a96a3; --fg:#e8eef5; --acc:#69b6ff; --ok:#5bd68a; --warn:#ffb15a; --err:#ff6b6b; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    h1{font-size:18px;margin:16px 0}
    .app{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{background:var(--panel);border:1px solid #1d2430;border-radius:10px;padding:12px;flex:1}
    .col.sm{flex:0 0 380px}
    label{display:block;margin:10px 0 6px;color:var(--muted)}
    input[type="range"]{width:100%}
    input[type="number"],select{width:100%;background:#0f141b;border:1px solid #222b39;color:var(--fg);border-radius:8px;padding:8px}
    .btn{background:#1b2532;border:1px solid #2a374a;color:var(--fg);padding:8px 10px;border-radius:8px;cursor:pointer}
    .muted{color:var(--muted)}
    .bar{height:8px;background:#233044;border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:100%;background:var(--acc)}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f1620;border:1px solid #263248;margin-right:6px}
    .chunk{background:#0e131a;border:1px solid #1a2230;border-radius:8px;padding:8px;margin:8px 0}
    .chunk .score{float:right;color:var(--muted)}
    code.inline{background:#0c1218;border:1px solid #1b2330;border-radius:6px;padding:2px 6px}
    .pipeline{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .pipebox{background:#0e141b;border:1px solid #1f2837;border-radius:10px;padding:8px 10px;min-width:140px}
    .pipebox.good{outline:2px solid var(--ok)}
    .pipebox.warn{outline:2px solid var(--warn)}
    .pipebox.err{outline:2px solid var(--err)}
    .arrow{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .small{font-size:12px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
  </style>
</head>
<body>
<div class="app">
  <h1>ðŸ§© Tiny RAG Visualizer â€” <span class="muted">precomputed doc embeddings</span></h1>

  <div class="row">
    <div class="col sm">
      <div style="display:flex;gap:8px;align-items:center">
        <span id="status" class="muted small">initializingâ€¦</span>
      </div>

      <label style="margin-top:14px">Model</label>
      <select id="model" disabled>
        <option value="Xenova/all-MiniLM-L6-v2">Xenova/all-MiniLM-L6-v2 (queries only)</option>
      </select>

      <label>Query</label>
      <select id="querySel" disabled></select>

      <div class="grid">
        <div>
          <label>Top-k</label>
          <input id="topk" type="range" min="1" max="10" step="1" value="6"/>
          <input id="topkNum" type="number" min="1" max="10" step="1" value="6"/>
        </div>
        <div>
          <label>Docs normalization</label>
          <div class="muted small">pre-normalized (cosine via inner product)</div>
        </div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <span class="badge">N docs: <span id="ndocs">â€”</span></span>
        <span class="badge">dim: <span id="dim">â€”</span></span>
      </div>
    </div>

    <div class="col">
      <label>Pipeline</label>
      <div class="pipeline" id="pipeline">
        <div class="pipebox" id="p0">Fetch JSON+vectors<br><span class="muted small" id="p0meta">â€”</span></div>
        <div class="arrow">âžœ</div>
        <div class="pipebox" id="p1">Embed query<br><span class="muted small" id="p1meta">â€”</span></div>
        <div class="arrow">âžœ</div>
        <div class="pipebox" id="p2">Retrieve<br><span class="muted small" id="p2meta">â€”</span></div>
        <div class="arrow">âžœ</div>
        <div class="pipebox" id="p3">Assemble<br><span class="muted small" id="p3meta">â€”</span></div>
      </div>

      <div class="grid" style="margin-top:10px">
        <div>
          <label>Retrieved docs <span class="muted small" id="retCount">0</span></label>
          <div id="results"></div>
        </div>
        <div>
          <label>Assembled Context</label>
          <div class="chunk mono small" id="context" style="white-space:pre-wrap; max-height:340px; overflow:auto"></div>
        </div>
      </div>

      <div style="margin-top:10px">
        <span class="badge">t_fetch: <span id="t0">â€”</span> ms</span>
        <span class="badge">t_embed_query: <span id="t1">â€”</span> ms</span>
        <span class="badge">t_retrieve: <span id="t2">â€”</span> ms</span>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';

const $ = s => document.querySelector(s);
const syncPair=(range,num)=>{range.addEventListener('input',()=>{num.value=range.value; onParamsChanged();}); num.addEventListener('input',()=>{range.value=num.value; onParamsChanged();});};
syncPair($('#topk'), $('#topkNum'));
function setPipe(id, meta, cls='good'){ const el=$(id); el.classList.remove('good','warn','err'); el.classList.add(cls); $(id+'meta').textContent=meta; }

//
// URLs on your HF dataset repo (after you upload the pack from Colab)
//
const DATASET_URL  = "https://huggingface.co/datasets/3rd-Degree-Burn/RAG/resolve/main/dataset.json";
const QUERIES_URL  = "https://huggingface.co/datasets/3rd-Degree-Burn/RAG/resolve/main/queries.json";
const MANIFEST_URL = "https://huggingface.co/datasets/3rd-Degree-Burn/RAG/resolve/main/manifest-web.json"; // -> docs.bin path lives inside

async function fetchText(url){
  try { const r = await fetch(url); if(r.ok) return await r.text(); } catch(_){ }
  const r2 = await fetch('https://r.jina.ai/' + url);
  if(!r2.ok) throw new Error('Fetch failed '+r2.status);
  return await r2.text();
}
async function fetchJSON(url){ const t0=performance.now(); const txt=await fetchText(url); const js=JSON.parse(txt); $('#t0').textContent=(performance.now()-t0).toFixed(1); return js; }
async function fetchBin(url){ const t0=performance.now(); const r = await fetch(url); if(!r.ok) throw new Error('Bin fetch failed '+r.status); const buf = await r.arrayBuffer(); $('#t0').textContent=(performance.now()-t0).toFixed(1); return buf; }

let DOCS=[], QUERIES=[], DOC_EMB=null, D=0, extractor=null, READY=false, lastQueryIndex=0;

function normalizeVec(v){ let s=0; for(let i=0;i<v.length;i++) s+=v[i]*v[i]; const n=Math.sqrt(s)||1; for(let i=0;i<v.length;i++) v[i]/=n; return v; }
function cosineTopK(q, topk){
  const N=DOCS.length, dim=D; const scores=new Array(N); const t0=performance.now();
  for(let i=0;i<N;i++){ let s=0, off=i*dim; for(let j=0;j<dim;j++) s+=q[j]*DOC_EMB[off+j]; scores[i]=[i,s]; }
  scores.sort((a,b)=>b[1]-a[1]); $('#t2').textContent=(performance.now()-t0).toFixed(1);
  return scores.slice(0,topk).map((p,idx)=>({rank:idx+1, idx:p[0], score:p[1]}));
}

async function loadModel(){ extractor = await pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2', { quantized:true }); }
async function embedOneQuery(qText){
  const t0=performance.now();
  const out = await extractor(qText, { pooling:'mean', normalize:true }); // docs are pre-normalized
  const qv = out?.data ? out.data : (Array.isArray(out) ? Float32Array.from(out[0]) : Float32Array.from(out));
  normalizeVec(qv); // ensure unit-length
  $('#t1').textContent=(performance.now()-t0).toFixed(1);
  return qv;
}

function fillQueries(){
  const sel=$('#querySel'); sel.innerHTML='';
  QUERIES.forEach((q,i)=>{ const opt=document.createElement('option'); opt.value=String(i); opt.textContent=q; sel.appendChild(opt); });
  sel.disabled=false;
}

function renderResults(items){
  const res=$('#results'); res.innerHTML=''; $('#retCount').textContent=String(items.length); const assembled=[];
  items.forEach(it=>{
    const d=DOCS[it.idx]; const wrap=document.createElement('div'); wrap.className='chunk';
    const bar=document.createElement('div'); bar.className='bar'; bar.title=String(it.score.toFixed(4));
    const fill=document.createElement('i'); fill.style.width=`${Math.max(0,Math.min(1,it.score))*100}%`; bar.appendChild(fill);
    const header=document.createElement('div');
    header.innerHTML=`<strong>#${it.rank}</strong> <span class="muted">doc</span> <code class="inline">${d.id}</code> <span class="score">score: ${it.score.toFixed(3)}</span><br><span class="muted small">${d.title||'(no title)'}</span>`;
    const text=document.createElement('div'); text.className='small'; text.style.marginTop='6px'; const t=d.text; text.textContent=t.slice(0,420)+(t.length>420?'â€¦':'');
    wrap.appendChild(header); wrap.appendChild(bar); wrap.appendChild(text); res.appendChild(wrap); assembled.push(d.text);
  });
  $('#context').textContent=assembled.join('\n\n');
}

async function runSearch(){
  if (!READY) return;
  setPipe('#p1','embedding queryâ€¦','warn');
  const qv = await embedOneQuery(QUERIES[lastQueryIndex]);
  setPipe('#p1','query ready','good');
  const k = Math.max(1, +$('#topk').value|0);
  const items = cosineTopK(qv, k);
  renderResults(items);
  setPipe('#p2',`top-k=${k}`,'good'); setPipe('#p3','assembled','good');
}
function onParamsChanged(){ if(READY) runSearch(); }

$('#querySel').addEventListener('change', ()=>{ lastQueryIndex=+$('#querySel').value|0; runSearch(); });
$('#topk').addEventListener('input', onParamsChanged);
$('#topkNum').addEventListener('input', onParamsChanged);

async function boot(){
  try{
    setPipe('#p0','fetching dataset & queriesâ€¦','warn');
    const [ds, qs, manifest] = await Promise.all([
      fetchJSON(DATASET_URL),
      fetchJSON(QUERIES_URL),
      fetchJSON(MANIFEST_URL),
    ]);
    if(!Array.isArray(ds)) throw new Error('dataset.json must be an array');
    DOCS = ds.map((r,i)=>({ id:String(r.id??`row-${i}`), title:String(r.title??''), text:String(r.text??'') }));
    QUERIES = Array.isArray(qs) ? qs.slice() : (Array.isArray(qs.queries) ? qs.queries.slice() : []);
    if(QUERIES.length===0) throw new Error('queries.json empty');

    const base = MANIFEST_URL.replace(/manifest-web\.json$/,'');
    const docsBuf = await fetchBin(base + manifest.files.docs_bin);
    const docs = new Float32Array(docsBuf);
    const [n,d] = manifest.shapes.docs;
    if (docs.length !== n*d) throw new Error(`docs.bin length ${docs.length} != ${n*d}`);
    DOC_EMB = docs; D = d;

    $('#ndocs').textContent = String(n);
    $('#dim').textContent  = String(d);
    setPipe('#p0',`dataset: ${DOCS.length} â€¢ vectors: ${n}x${d}`,'good');

    setPipe('#p1','loading modelâ€¦','warn');
    await loadModel();

    fillQueries();
    $('#model').disabled=false;
    $('#status').textContent='ready';
    lastQueryIndex = 0; $('#querySel').value='0';
    READY = true;
    runSearch();
  }catch(e){
    console.error(e);
    $('#status').textContent='failed: '+e.message;
    setPipe('#p0','failed','err'); setPipe('#p1','failed','err');
  }
}

window.addEventListener('DOMContentLoaded', boot);
</script>
</body>
</html>
