<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Tiny RAG Visualizer â€” Client-side Embeddings</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0b0d10; --panel:#12161b; --muted:#8a96a3; --fg:#e8eef5; --acc:#69b6ff; --ok:#5bd68a; --warn:#ffb15a; --err:#ff6b6b; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    h1{font-size:18px;margin:16px 0}
    .app{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{background:var(--panel);border:1px solid #1d2430;border-radius:10px;padding:12px;flex:1}
    .col.sm{flex:0 0 360px}
    label{display:block;margin:10px 0 6px;color:var(--muted)}
    input[type="range"]{width:100%}
    input[type="number"],textarea,select{width:100%;background:#0f141b;border:1px solid #222b39;color:var(--fg);border-radius:8px;padding:8px}
    .btn{background:#1b2532;border:1px solid #2a374a;color:var(--fg);padding:8px 10px;border-radius:8px;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .muted{color:var(--muted)}
    .bar{height:8px;background:#233044;border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:100%;background:var(--acc)}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f1620;border:1px solid #263248;margin-right:6px}
    .chunk{background:#0e131a;border:1px solid #1a2230;border-radius:8px;padding:8px;margin:8px 0}
    .chunk .score{float:right;color:var(--muted)}
    code.inline{background:#0c1218;border:1px solid #1b2330;border-radius:6px;padding:2px 6px}
    .pipeline{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .pipebox{background:#0e141b;border:1px solid #1f2837;border-radius:10px;padding:8px 10px;min-width:140px}
    .pipebox.good{outline:2px solid var(--ok)}
    .pipebox.warn{outline:2px solid var(--warn)}
    .pipebox.err{outline:2px solid var(--err)}
    .arrow{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .small{font-size:12px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .footer{margin-top:8px;color:var(--muted)}
  </style>
  <!-- Transformers.js (runs on WebGPU/WebGL/WebAssembly) -->
  <script src="https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2"></script>
</head>
<body>
<div class="app">
  <h1>ðŸ§© Tiny RAG Visualizer â€” <span class="muted">client-side embeddings</span></h1>

  <div class="row">
    <div class="col sm">
      <label>Dataset source</label>
      <input id="src" value="ag_news â€¢ train â€¢ first 250 rows" disabled />
      <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
        <button class="btn" id="init">Load & Embed</button>
        <span id="status" class="muted small">idle</span>
      </div>

      <label style="margin-top:14px">Model</label>
      <select id="model" disabled>
        <option value="Xenova/all-MiniLM-L6-v2">Xenova/all-MiniLM-L6-v2 (quantized)</option>
      </select>

      <label>Query (your preselected list)</label>
      <select id="querySel" disabled></select>

      <div class="grid">
        <div>
          <label>Top-k</label>
          <input id="topk" type="range" min="1" max="10" step="1" value="6"/>
          <input id="topkNum" type="number" min="1" max="10" step="1" value="6"/>
        </div>
        <div>
          <label>Normalize & cosine</label>
          <div style="display:flex;gap:8px;align-items:center">
            <input id="normalize" type="checkbox" checked />
            <span class="muted small">unit-length vectors</span>
          </div>
        </div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
        <button class="btn" id="run" disabled>Run</button>
        <span class="badge">N docs: <span id="ndocs">â€”</span></span>
        <span class="badge">dim: <span id="dim">â€”</span></span>
      </div>

      <div class="footer small">
        Everything computed in your browser using <code class="inline">Transformers.js</code> + <code class="inline">MiniLM-L6-v2</code>.
      </div>
    </div>

    <div class="col">
      <label>Pipeline</label>
      <div class="pipeline" id="pipeline">
        <div class="pipebox" id="p0">Fetch rows<br><span class="muted small" id="p0meta">â€”</span></div>
        <div class="arrow">âžœ</div>
        <div class="pipebox" id="p1">Embed docs<br><span class="muted small" id="p1meta">â€”</span></div>
        <div class="arrow">âžœ</div>
        <div class="pipebox" id="p2">Embed query<br><span class="muted small" id="p2meta">â€”</span></div>
        <div class="arrow">âžœ</div>
        <div class="pipebox" id="p3">Retrieve<br><span class="muted small" id="p3meta">â€”</span></div>
        <div class="arrow">âžœ</div>
        <div class="pipebox" id="p4">Assemble<br><span class="muted small" id="p4meta">â€”</span></div>
      </div>

      <div class="grid" style="margin-top:10px">
        <div>
          <label>Retrieved docs <span class="muted small" id="retCount">0</span></label>
          <div id="results"></div>
        </div>
        <div>
          <label>Assembled Context</label>
          <div class="chunk mono small" id="context" style="white-space:pre-wrap; max-height:340px; overflow:auto"></div>
        </div>
      </div>

      <div style="margin-top:10px">
        <span class="badge">t_fetch: <span id="t0">â€”</span> ms</span>
        <span class="badge">t_embed_docs: <span id="t1">â€”</span> ms</span>
        <span class="badge">t_embed_query: <span id="t2">â€”</span> ms</span>
        <span class="badge">t_retrieve: <span id="t3">â€”</span> ms</span>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------------- config / constants ---------------- */
const HF_ROWS_URL = "https://datasets-server.huggingface.co/rows?dataset=ag_news&config=default&split=train&offset=0&length=250";
// Your queries from the Colab cell:
const PRE_QUERIES = [
  "What does a new Internet advertising forecast show regarding paid search listings?",
  "What gives orange coral its glow?",
  "Why will people need to eat less meat?",
  "Where is the pit with the world's believed deepest vertical drop located?",
  "According to the APMF survey, which destination is currently leading as the best Asian tourism destination?"
];

const $ = s => document.querySelector(s);
const syncPair=(range,num)=>{range.addEventListener('input',()=>num.value=range.value);num.addEventListener('input',()=>range.value=num.value);};
syncPair($('#topk'), $('#topkNum'));

function setPipe(id, meta, cls='good'){
  const el = $(id);
  el.classList.remove('good','warn','err');
  el.classList.add(cls);
  $(id+'meta').textContent = meta;
}

/* ---------------- state ---------------- */
let DOCS = [];         // {id, title, text}
let DOC_EMB = null;    // Float32Array length=N*D
let D = 0;             // embedding dim
let extractor = null;  // transformers.js pipeline

/* ---------------- utils ---------------- */
function normalizeVec(v){
  let s=0; for(let i=0;i<v.length;i++) s+=v[i]*v[i];
  const n = Math.sqrt(s) || 1;
  for(let i=0;i<v.length;i++) v[i]=v[i]/n;
  return v;
}

function cosineTopK(q, topk){
  const N = DOCS.length, dim = D;
  const scores = new Array(N);
  const t0 = performance.now();
  for(let i=0;i<N;i++){
    let s=0;
    const base = i*dim;
    for(let j=0;j<dim;j++) s += q[j] * DOC_EMB[base+j];
    scores[i] = [i, s];
  }
  scores.sort((a,b)=>b[1]-a[1]);
  $('#t3').textContent = (performance.now()-t0).toFixed(1);
  return scores.slice(0, topk).map((p, idx)=>({rank: idx+1, idx: p[0], score: p[1]}));
}

function labelName(y){
  // ag_news labels: 0=World, 1=Sports, 2=Business, 3=Sci/Tech
  return ["World","Sports","Business","Sci/Tech"][y] ?? "";
}

/* ---------------- data / embeddings ---------------- */
async function fetchRows(){
  const t0 = performance.now();
  const res = await fetch(HF_ROWS_URL);
  if(!res.ok) throw new Error(`Rows fetch failed: ${res.status}`);
  const js = await res.json();
  const rows = js.rows || [];
  DOCS = rows.map((r, i) => {
    const row = r.row || {};
    return {
      id: `hf-ag_news-train-${String(i).padStart(5,'0')}`,
      title: labelName(row.label),
      text: row.text || ""
    };
  });
  $('#t0').textContent = (performance.now()-t0).toFixed(1);
  $('#ndocs').textContent = String(DOCS.length);
}

async function loadModel(){
  // feature-extraction pipeline; quantized for smaller downloads
  const { pipeline } = window.transformers;
  extractor = await pipeline('feature-extraction', 'Xenova/all-MiniLM-L6-v2', { quantized: true });
}

async function embedBatch(texts){
  // Transformers.js supports batching by passing an array
  const out = await extractor(texts, { pooling: 'mean', normalize: $('#normalize').checked });
  // out can be {data: Float32Array, dims:[B,D]} or nested arrays depending on version
  if (out?.data && out?.dims?.length === 2) {
    return { data: out.data, dim: out.dims[1] };
  } else if (Array.isArray(out)) {
    // older return path: array of Float32Array
    const dim = out[0].length;
    const data = new Float32Array(out.length * dim);
    for(let i=0;i<out.length;i++) data.set(out[i], i*dim);
    return { data, dim };
  } else {
    // single example path
    const vec = out?.data ? out.data : Float32Array.from(out);
    return { data: vec, dim: vec.length };
  }
}

async function embedAllDocs(){
  const B = 16; // batch size
  const N = DOCS.length;
  let dim = null;
  const store = [];
  const t0 = performance.now();
  for(let i=0;i<N;i+=B){
    const chunk = DOCS.slice(i, i+B).map(d=>d.text);
    const { data, dim: d } = await embedBatch(chunk);
    if(dim==null) dim = d;
    store.push(data);
  }
  const all = new Float32Array(store.reduce((s,a)=>s+a.length,0));
  let off=0; for(const a of store){ all.set(a, off); off += a.length; }
  D = dim;
  DOC_EMB = all;
  $('#dim').textContent = String(D);
  $('#t1').textContent = (performance.now()-t0).toFixed(1);
}

async function embedOneQuery(qText){
  const out = await extractor(qText, { pooling: 'mean', normalize: $('#normalize').checked });
  let qv;
  if(out?.data) qv = out.data;
  else if(Array.isArray(out)) qv = Float32Array.from(out[0]);
  else qv = Float32Array.from(out);
  if(!$('#normalize').checked) normalizeVec(qv);
  return qv;
}

/* ---------------- UI ---------------- */
function fillQueries(){
  const sel = $('#querySel');
  sel.innerHTML = '';
  PRE_QUERIES.forEach((q,i)=>{
    const opt = document.createElement('option');
    opt.value = String(i);
    opt.textContent = q;
    sel.appendChild(opt);
  });
  sel.disabled = false;
}

function renderResults(items){
  const res = $('#results'); res.innerHTML='';
  $('#retCount').textContent = String(items.length);
  const assembled = [];
  items.forEach(it=>{
    const d = DOCS[it.idx];
    const wrap = document.createElement('div'); wrap.className='chunk';
    const bar = document.createElement('div'); bar.className='bar'; bar.title=String(it.score.toFixed(4));
    const fill = document.createElement('i'); fill.style.width = `${Math.max(0, Math.min(1, it.score))*100}%`;
    bar.appendChild(fill);
    const header = document.createElement('div');
    header.innerHTML = `<strong>#${it.rank}</strong> <span class="muted">doc</span> <code class="inline">${d.id}</code> <span class="score">score: ${it.score.toFixed(3)}</span><br><span class="muted small">${d.title || '(no title)'}</span>`;
    const text = document.createElement('div'); text.className='small'; text.style.marginTop='6px';
    const t = d.text; text.textContent = t.slice(0, 420) + (t.length>420 ? 'â€¦' : '');
    wrap.appendChild(header); wrap.appendChild(bar); wrap.appendChild(text);
    res.appendChild(wrap);
    assembled.push(d.text);
  });
  $('#context').textContent = assembled.join('\n\n');
}

$('#init').addEventListener('click', async ()=>{
  try{
    $('#status').textContent = 'fetchingâ€¦';
    setPipe('#p0','fetching rowsâ€¦','warn');
    await fetchRows();
    setPipe('#p0', `rows: ${DOCS.length}`, 'good');

    $('#status').textContent = 'loading modelâ€¦';
    setPipe('#p1','loading modelâ€¦','warn');
    await loadModel();

    $('#status').textContent = 'embedding docsâ€¦';
    await embedAllDocs();
    setPipe('#p1', `embedded ${DOCS.length} docs`, 'good');

    fillQueries();
    $('#model').disabled = false;
    $('#run').disabled = false;
    $('#status').textContent = 'ready';
    setPipe('#p2','pick a query','warn');
  }catch(e){
    console.error(e);
    $('#status').textContent = 'failed: ' + e.message;
    setPipe('#p0','failed','err'); setPipe('#p1','failed','err');
  }
});

$('#run').addEventListener('click', async ()=>{
  try{
    const qi = +$('#querySel').value|0;
    const qText = PRE_QUERIES[qi];
    setPipe('#p2', `query #${qi+1}`, 'good');

    const t0 = performance.now();
    const qv = await embedOneQuery(qText);
    $('#t2').textContent = (performance.now()-t0).toFixed(1);

    const k = +$('#topk').value|0;
    const items = cosineTopK(qv, k);
    renderResults(items);
    setPipe('#p3', `top-k=${k}`, 'good');
    setPipe('#p4', 'assembled', 'good');
  }catch(e){
    console.error(e);
    setPipe('#p3', 'failed', 'err');
  }
});

/* boot */
window.addEventListener('load', ()=>{
  setPipe('#p0','idle','warn');
  $('#status').textContent = 'idle';
});
</script>
</body>
</html>
