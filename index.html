<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Tiny RAG Visualizer (Pure HTML/CSS/JS)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --bg:#0b0d10; --panel:#12161b; --muted:#8a96a3; --fg:#e8eef5; --acc:#69b6ff; --ok:#5bd68a; --warn:#ffb15a; }
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    h1{font-size:18px;margin:16px 0}
    .app{max-width:1100px;margin:0 auto;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{background:var(--panel);border:1px solid #1d2430;border-radius:10px;padding:12px;flex:1}
    .col.sm{flex:0 0 360px}
    label{display:block;margin:10px 0 6px;color:var(--muted)}
    input[type="range"]{width:100%}
    input[type="number"],textarea,select{width:100%;background:#0f141b;border:1px solid #222b39;color:var(--fg);border-radius:8px;padding:8px}
    textarea{min-height:70px;resize:vertical}
    .btn{background:#1b2532;border:1px solid #2a374a;color:var(--fg);padding:8px 10px;border-radius:8px;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .muted{color:var(--muted)}
    .bar{height:8px;background:#233044;border-radius:999px;overflow:hidden}
    .bar>i{display:block;height:100%;background:var(--acc)}
    .badge{display:inline-block;padding:2px 8px;border-radius:999px;background:#0f1620;border:1px solid #263248;margin-right:6px}
    .chunk{background:#0e131a;border:1px solid #1a2230;border-radius:8px;padding:8px;margin:8px 0}
    .chunk .score{float:right;color:var(--muted)}
    code.inline{background:#0c1218;border:1px solid #1b2330;border-radius:6px;padding:2px 6px}
    .pipeline{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .pipebox{background:#0e141b;border:1px solid #1f2837;border-radius:10px;padding:8px 10px;min-width:140px}
    .pipebox.good{outline:2px solid var(--ok)}
    .arrow{color:var(--muted)}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .small{font-size:12px}
    .mono{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .hl{background:#1c2a3a}
    .footer{margin-top:8px;color:var(--muted)}
    .pill{background:#0f1b26;border:1px solid #243245;border-radius:999px;padding:2px 8px;margin-left:6px}
  </style>
  <!-- fflate for in-browser unzip (fast, tiny) -->
  <script src="https://cdn.jsdelivr.net/npm/fflate@0.8.2/umd/index.min.js"></script>
</head>
<body>
<div class="app">
  <h1>ðŸ§© Tiny RAG Visualizer (client-only, precomputed)</h1>

  <div class="row">
    <div class="col sm">
      <label>Data pack</label>
      <div style="display:flex; gap:8px">
        <button class="btn" id="loadZip">Load vector_dbs.zip</button>
        <input type="file" id="zipFile" accept=".zip" style="flex:1" />
      </div>
      <div class="small muted" id="status">Pack not loaded.</div>

      <label>Model</label>
      <select id="modelSel" disabled></select>

      <label>Query <span class="pill small" id="qHint">select from list (precomputed)</span></label>
      <select id="querySel" disabled></select>
      <textarea id="query" placeholder="(Optional) Type your own â€” but only precomputed queries have vectors client-side"></textarea>

      <div class="grid">
        <div>
          <label>Top-k</label>
          <input id="topk" type="range" min="1" max="12" step="1" value="6"/>
          <input id="topkNum" type="number" min="1" max="12" step="1" value="6"/>
        </div>
        <div>
          <label>Context assembly</label>
          <select id="contextMode">
            <option value="snippets">Titles only</option>
            <option value="full">Full text (needs docs_text.jsonl.gz)</option>
          </select>
        </div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px">
        <button class="btn" id="run" disabled>Run</button>
      </div>

      <div class="footer small">
        100% client-side. Uses precomputed neighbors from <code class="inline">neighbors_topk.json</code>.
        Optional doc texts via <code class="inline">docs_text.jsonl.gz</code>.
      </div>
    </div>

    <div class="col">
      <label>Pipeline</label>
      <div class="pipeline" id="pipeline">
        <div class="pipebox" id="p1">Load Pack<br><span class="muted small" id="p1meta">â€”</span></div>
        <div class="arrow">âžœ</div>
        <div class="pipebox" id="p2">Select Model<br><span class="muted small" id="p2meta">â€”</span></div>
        <div class="arrow">âžœ</div>
        <div class="pipebox" id="p3">Retrieve<br><span class="muted small" id="p3meta">â€”</span></div>
        <div class="arrow">âžœ</div>
        <div class="pipebox" id="p4">Assemble<br><span class="muted small" id="p4meta">â€”</span></div>
      </div>

      <div class="grid" style="margin-top:10px">
        <div>
          <label>Retrieved docs <span class="muted small" id="retCount">0</span></label>
          <div id="results"></div>
        </div>
        <div>
          <label>Assembled Context</label>
          <div class="chunk mono small" id="context" style="white-space:pre-wrap; max-height:320px; overflow:auto"></div>
        </div>
      </div>

      <div style="margin-top:10px">
        <span class="badge">t_load: <span id="t1">â€”</span> ms</span>
        <span class="badge">t_select: <span id="t2">â€”</span> ms</span>
        <span class="badge">t_retrieve: <span id="t3">â€”</span> ms</span>
        <span class="badge">t_assemble: <span id="t4">â€”</span> ms</span>
      </div>
    </div>
  </div>
</div>

<script>
/* ------------------------ Config ------------------------ */
const ZIP_URL = 'vector_dbs.zip'; // adjust if hosted elsewhere

/* ------------------------ UI helpers ------------------------ */
const $ = s => document.querySelector(s);
const syncPair = (range, num) => {
  range.addEventListener('input', () => { num.value = range.value; });
  num.addEventListener('input', () => { range.value = num.value; });
};
syncPair($('#topk'), $('#topkNum'));

function setPipe(id, meta, ok=false){
  const el = $(id);
  el.classList.toggle('good', ok);
  $(id+'meta').textContent = meta;
}

/* ------------------------ Unzip + FS ------------------------ */
let ZIPFS = null; // { path -> Uint8Array }

async function fetchZip(url){
  const t0 = performance.now();
  $('#status').textContent = `Fetching ${url} â€¦`;
  const res = await fetch(url);
  if(!res.ok) throw new Error(`HTTP ${res.status}`);
  const buf = await res.arrayBuffer();
  $('#status').textContent = `Unzipping â€¦`;
  const files = fflate.unzipSync(new Uint8Array(buf)); // {name: Uint8Array}
  const t1 = performance.now();
  ZIPFS = files;
  $('#status').textContent = `Pack ready (${Object.keys(files).length} files).`;
  setPipe('#p1', 'zip loaded', true);
  $('#t1').textContent = (t1 - t0).toFixed(1);
}

function readText(path){
  const u8 = ZIPFS[path];
  if(!u8) throw new Error(`Missing in zip: ${path}`);
  return new TextDecoder('utf-8').decode(u8);
}

function readJSON(path){
  return JSON.parse(readText(path));
}

function readMaybe(path){ // returns Uint8Array or null
  return ZIPFS[path] || null;
}

/* ------------------------ State ------------------------ */
let ROOT = null;           // vector_dbs/manifest.json
let MODELS = [];           // from ROOT.items
let CURRENT = null;        // { manWeb, queries, docsMeta, neighbors, docsTextLUT? }
let CURRENT_MODEL_FOLDER = null;

/* ------------------------ Load root manifest ------------------------ */
function populateModels(){
  const sel = $('#modelSel');
  sel.innerHTML = '';
  MODELS.forEach(item=>{
    const opt = document.createElement('option');
    opt.value = item.folder;
    opt.textContent = `${item.model_id || item.folder}`;
    sel.appendChild(opt);
  });
  sel.disabled = MODELS.length===0;
}

function populateQueries(qs){
  const sel = $('#querySel');
  sel.innerHTML = '';
  qs.forEach((q,i)=>{
    const opt = document.createElement('option');
    opt.value = String(i);
    opt.textContent = q;
    sel.appendChild(opt);
  });
  sel.disabled = qs.length===0;
}

/* ------------------------ Load a model pack ------------------------ */
function pathJoin(...parts){
  return parts.join('/').replace(/\/+/g,'/');
}

function tryLoadDocsText(modelFolder){
  // Optional: web/docs_text.jsonl.gz (one JSON per line: {id,title,text})
  const gzPath = pathJoin('vector_dbs', modelFolder, 'web/docs_text.jsonl.gz');
  const raw = readMaybe(gzPath);
  if(!raw) return null;
  // gunzip
  const unz = fflate.decompressSync(raw);
  const txt = new TextDecoder('utf-8').decode(unz);
  const lut = {};
  txt.split(/\r?\n/).forEach(line=>{
    if(!line.trim()) return;
    try {
      const o = JSON.parse(line);
      lut[o.id] = o;
    } catch(e){}
  });
  return lut; // { id -> {id,title,text} }
}

function selectModel(modelFolder){
  const t0 = performance.now();
  CURRENT_MODEL_FOLDER = modelFolder;
  const base = pathJoin('vector_dbs', modelFolder, 'web');
  const manWeb = readJSON(pathJoin(base, 'manifest-web.json'));
  const queries = readJSON(pathJoin(base, 'queries.json'));
  const docsMeta = readJSON(pathJoin(base, 'docs_meta.json'));
  const neighbors = readJSON(pathJoin(base, 'neighbors_topk.json'));
  const docsTextLUT = tryLoadDocsText(modelFolder); // optional

  CURRENT = { manWeb, queries, docsMeta, neighbors, docsTextLUT };
  populateQueries(queries);

  const t1 = performance.now();
  setPipe('#p2', `${modelFolder}`, true);
  $('#t2').textContent = (t1 - t0).toFixed(1);
  $('#run').disabled = false;
}

/* ------------------------ Retrieval (precomputed) ------------------------ */
function run(){
  if(!CURRENT){ alert('Load pack and select a model first.'); return; }
  const topk = Math.max(1, +$('#topk').value|0);
  const qSel = $('#querySel');
  const qIdx = qSel.selectedIndex >= 0 ? qSel.selectedIndex : 0;
  const qText = CURRENT.queries[qIdx] || '';
  $('#query').value = qText; // reflect in textarea

  const t0 = performance.now();
  const entry = CURRENT.neighbors[qIdx]; // { query, topk: [{doc_index, doc_id, title, score}, ...] }
  const items = (entry?.topk || []).slice(0, topk);
  const t1 = performance.now();

  // Render results list
  const container = $('#results');
  container.innerHTML = '';
  $('#retCount').textContent = String(items.length);

  items.forEach((it, rank)=>{
    const wrap = document.createElement('div');
    wrap.className = 'chunk';
    const header = document.createElement('div');
    header.innerHTML = `<strong>#${rank+1}</strong> <span class="muted">doc</span> <code class="inline">${it.doc_id}</code> `
      + `<span class="muted">title</span> <code class="inline">${(it.title||'').replace(/</g,'&lt;')}</code>`
      + ` <span class="score">score: ${it.score.toFixed(3)}</span>`;
    const bar = document.createElement('div'); bar.className = 'bar'; bar.title = String(it.score.toFixed(4));
    const fill = document.createElement('i'); fill.style.width = `${Math.max(0, Math.min(1, it.score))*100}%`;
    bar.appendChild(fill);
    wrap.appendChild(header);
    wrap.appendChild(bar);
    container.appendChild(wrap);
  });

  // Assemble context (if docs_text available)
  const t2 = performance.now();
  let context = '';
  if($('#contextMode').value === 'full' && CURRENT.docsTextLUT){
    items.forEach((it, idx)=>{
      const row = CURRENT.docsTextLUT[it.doc_id];
      if(row && row.text){
        context += `#${idx+1} â€” ${row.title||it.doc_id}\n${row.text}\n\n`;
      } else {
        context += `#${idx+1} â€” ${it.title||it.doc_id}\n(text not included in pack)\n\n`;
      }
    });
  } else {
    context = items.map((it, idx)=> `#${idx+1} â€” ${it.title||it.doc_id}`).join('\n');
    if($('#contextMode').value === 'full') context += `\n\n(no docs_text.jsonl.gz found in pack)`;
  }
  const t3 = performance.now();

  $('#context').textContent = context || '(no results)';
  setPipe('#p3', `top-k=${topk}`, true);
  setPipe('#p4', `${context.length} chars`, true);
  $('#t3').textContent = (t1 - t0).toFixed(1);
  $('#t4').textContent = (t3 - t2).toFixed(1);
}

/* ------------------------ Wire up ------------------------ */
$('#loadZip').addEventListener('click', async ()=>{
  try {
    await fetchZip(ZIP_URL);
    ROOT = readJSON('vector_dbs/manifest.json');
    MODELS = ROOT.items || [];
    populateModels();
    $('#modelSel').disabled = false;
    $('#status').textContent += ' | Manifest loaded.';
  } catch(e){
    console.error(e);
    $('#status').textContent = 'Failed to load zip. You can choose a local file below.';
  }
});

$('#zipFile').addEventListener('change', async (e)=>{
  const file = e.target.files?.[0];
  if(!file) return;
  const t0 = performance.now();
  $('#status').textContent = `Reading ${file.name} â€¦`;
  const buf = await file.arrayBuffer();
  $('#status').textContent = `Unzipping â€¦`;
  ZIPFS = fflate.unzipSync(new Uint8Array(buf));
  const t1 = performance.now();
  ROOT = readJSON('vector_dbs/manifest.json');
  MODELS = ROOT.items || [];
  populateModels();
  $('#modelSel').disabled = false;
  setPipe('#p1', 'zip (local) loaded', true);
  $('#t1').textContent = (t1 - t0).toFixed(1);
  $('#status').textContent = `Pack ready (local).`;
});

$('#modelSel').addEventListener('change', ()=>{
  const folder = $('#modelSel').value;
  selectModel(folder);
});

$('#querySel').addEventListener('change', ()=>{
  // keep textarea synced for clarity
  const idx = $('#querySel').selectedIndex;
  $('#query').value = CURRENT?.queries?.[idx] || '';
});

$('#run').addEventListener('click', run);

// Initialize UI
window.addEventListener('load', ()=>{
  $('#query').value = '';
  $('#retCount').textContent = '0';
  setPipe('#p1','â€”',false); setPipe('#p2','â€”',false); setPipe('#p3','â€”',false); setPipe('#p4','â€”',false);
});
</script>
</body>
</html>
